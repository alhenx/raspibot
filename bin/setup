#!/bin/sh

# Raspibot's setup script.
# Raúl Díez Sánchez - Alejandro Chacón Peregrino.

INSTALLDIR="/opt/raspibot-setup"
BOTPATH="$INSTALLDIR/raspibot"
BOTPATH_BAK="$BOTPATH-bak"
TORRENTENDPATH="/opt/torrentsend"
TORRENTSFILE="$TORRENTENDPATH/torrentsended"
AMBILIGHT="boblight-dispmanx"
TORRENTALERTSCRIPT="/usr/bin/torrent-finished.sh"
RESTARTSCRIPT="/usr/local/bin/restartraspibot.sh"
RASPIBOTSYSCTL_FILE="/usr/local/bin/raspibotsysctl"
RASPIBOT_SERVICE="raspibot.service"
SYS_USER=$(echo $USER)

function update_bot {
	cd # Va a /home/$SYS_USER
	mv $BOTPATH $BOTPATH_BAK
	git clone https://github.com/alhenx/raspibot.git $BOTPATH --quiet

	echo "Identificando sistema operativo y gestor de paquetes..."
	declare -A osInfo;
	osInfo[/etc/arch-release]=pacman
	osInfo[/etc/debian_version]=apt-get

	for f in ${!osInfo[@]}
	do
	    if [[ -f $f ]];then
	    		SYSTEM_PM=${osInfo[$f]}
	        echo "El gestor de paquetes de su sistema es $SYSTEM_PM."
	    fi
	done

	case $SYSTEM_PM in
		pacman)
			PM_INSTALL="$SYSTEM_PM -S --noconfirm"
			PM_CHECK="$SYSTEM_PM -Q --noconfirm"
			TORRENTSERVICEPKG="transmission-cli"
			TORRENTCTL="transmission"
			TORRENTSERVICESETTINGS="/var/lib/transmission/.config/transmission-daemon/settings.json"
		;;
		apt-get)
			PM_INSTALL="$SYSTEM_PM install -y"
			PM_CHECK="apt-cache policy"
			TORRENTSERVICEPKG="transmission-daemon"
			TORRENTCTL="transmission-daemon"
			TORRENTSERVICESETTINGS="/var/lib/transmission-daemon/.config/transmission-daemon/settings.json"
		;;
	esac

	echo "Configurando nueva versión..."
	cp -r $BOTPATH_BAK/config $BOTPATH
	cp -r $BOTPATH_BAK/tmp $BOTPATH
	touch $BOTPATH/tmp/update
	echo "Eliminando versiones anteriores..."
	rm -rf $BOTPATH_BAK
	if [ -f $RESTARTSCRIPT ] ; then
		sudo rm -f $RESTARTSCRIPT >/dev/null 2>&1
		sudo sed -i '\^'"$RESTARTSCRIPT"'^d' /etc/sudoers
	fi
	if [ ! -f $BOTPATH/config/torrentuser ] ; then
		echo -e "\nComprobando si cuenta con $TORRENTSERVICEPKG en el sistema..."
		if (eval sudo $PM_CHECK $TORRENTSERVICEPKG >/dev/null 2>&1) ; then
			echo "Se ha detectado $TORRENTSERVICEPKG instalado en el sistema."

			if [[ $TORRENTSERVICEPKG == "transmission-daemon" ]]; then
				if (eval sudo $PM_CHECK transmission-cli >/dev/null 2>&1) ; then
					sudo $PM_INSTALL transmission-cli >/dev/null
				fi
			fi

			echo "A continuación es necesario introducir el usuario y contraseña"
			echo "del servicio para $TORRENTSERVICEPKG web. Introduzca su usuario:"
			read TORRENTUSER

			echo -e "\nIntroduzca la contraseña:"
			read TORRENTPASS

			echo "Se añadirá este servicio a la lista de alertas de RaspiBot."

			sudo sed -i 's^"script-torrent-done-enabled": false,^"script-torrent-done-enabled": true,^g' $TORRENTSERVICESETTINGS
			sudo sed -i 's^"script-torrent-done-filename": "",^"script-torrent-done-filename": "'"$TORRENTALERTSCRIPT"'",^g' $TORRENTSERVICESETTINGS

			echo -e '#!/bin/sh' | sudo tee $TORRENTALERTSCRIPT >/dev/null
			echo -e 'torrentsalertfile="'"$TORRENTSFILE"'"' | sudo tee --append $TORRENTALERTSCRIPT >/dev/null
			echo -e 'echo $TR_TORRENT_NAME > $torrentsalertfile' | sudo tee --append $TORRENTALERTSCRIPT >/dev/null
			echo -e "exit 0" | sudo tee --append $TORRENTALERTSCRIPT >/dev/null

			sudo systemctl reload $TORRENTCTLPKG

			sudo chmod a+x $TORRENTALERTSCRIPT
			echo -n $TORRENTUSER > $BOTPATH/config/torrentuser
			echo -n $TORRENTPASS > $BOTPATH/config/torrentpass
		fi
	fi
	if [ ! -f $RASPIBOTSYSCTL_FILE ] ; then
		sudo ln -s $BOTPATH/bin/raspibotsysctl $RASPIBOTSYSCTL_FILE
	fi
	raspibot restart
	echo "Actualización completada."
}
######################
#END update_bot

KEEPON=true

while $KEEPON ;
do
	echo -e "**************************************************"
	echo -e "******* RaspiBot Beta Bermellón (de China) *******"
	echo -e "**************************************************"
	echo -e "Introduzca el número de la opción deseada del programa:\n"
	echo -e "\t1. Instalación de RaspiBot."
	echo -e "\t2. Actualización de RaspiBot."
	echo -e "\t3. Desinstalación de RaspiBot."
	echo -e "\t4. Salir."
	read X
		case $X in
			1)
				echo "******* INSTALACIÓN SELECCIONADA *******"
				echo "Identificando sistema operativo y gestor de paquetes..."
				declare -A osInfo;
				osInfo[/etc/arch-release]=pacman
				osInfo[/etc/debian_version]=apt-get

				for f in ${!osInfo[@]}
				do
				    if [[ -f $f ]];then
				    		SYSTEM_PM=${osInfo[$f]}
				        echo "El gestor de paquetes de su sistema es $SYSTEM_PM."
				    fi
				done

				case $SYSTEM_PM in
					pacman)
						PM_UPDATE="$SYSTEM_PM -Syy --noconfirm"
						PM_INSTALL="$SYSTEM_PM -S --noconfirm"
						PM_CHECK="$SYSTEM_PM -Q --noconfirm"
						SYSTEMD_DIR="/usr/lib/systemd/system/"
						TORRENTSERVICEPKG="transmission-cli"
						TORRENTCTL="transmission"
						TORRENTSERVICESETTINGS="/var/lib/transmission/.config/transmission-daemon/settings.json"
					;;
					apt-get)
						PM_UPDATE="$SYSTEM_PM update -y"
						PM_INSTALL="$SYSTEM_PM install -y"
						PM_CHECK="apt-cache policy"
						SYSTEMD_DIR="/lib/systemd/system/"
						TORRENTSERVICEPKG="transmission-daemon"
						TORRENTCTL="transmission-daemon"
						TORRENTSERVICESETTINGS="/var/lib/transmission-daemon/.config/transmission-daemon/settings.json"
					;;
				esac

				echo "Comenzando proceso de instalación..."
				cd # Va a /home/$SYS_USER
				echo "Sincronizando las bases de datos de los paquetes..."
				eval sudo $PM_UPDATE >/dev/null

				echo "Comprobando paquetes necesarios del sistema."
				PY_PKG="python"
				PIP_PKG="python-pip"
				#hay que rehacer
				if !(eval sudo $PM_CHECK $PY_PKG >/dev/null 2>&1) ; then
					echo "Instalando $PY_PKG..."
					eval sudo $PM_INSTALL $PY_PKG >/dev/null
				fi

				if !(eval sudo $PM_CHECK $PIP_PKG >/dev/null 2>&1) ; then
					echo "Instalando $PIP_PKG..."
					eval sudo $PM_INSTALL $PIP_PKG >/dev/null
				fi

				echo "Comprobando módulos pip."
				PIPMODULES[0]=pyTelegramBotAPI
				PIPMODULES[1]=wikipedia
				PIPMODULES[2]=feedparser

				for (( i=0; i<${#PIPMODULES[@]}; i++ ))
				do
					if ! pip list | grep ${PIPMODULES[$i]} >/dev/null ; then
						echo "Instalando módulo ${PIPMODULES[$i]}..."
						sudo pip install ${PIPMODULES[$i]} >/dev/null
					fi
				done

				echo "Creando directorios necesarios para la instalación..."
				sudo mkdir -p $INSTALLDIR
				sudo mkdir -p $TORRENTENDPATH
				sudo chmod a+wx $INSTALLDIR
				sudo chmod a+wx $TORRENTENDPATH

				echo "Instalando RaspiBot..."
				git clone https://github.com/alhenx/raspibot.git $BOTPATH --quiet

				echo "A continuación se configurarán algunos archivos..."
				mkdir $BOTPATH/tmp

				TOKEN_BOT_FILE=
				while [[ $TOKEN_BOT_FILE == "" ]]; do
					echo "Por favor, introduzca el API_TOKEN (no puede dejarse en blanco)"
					echo "de su Bot (se la facilitará @BotFather al crear su Bot):"
					read TOKEN_BOT_FILE
				done

				CHAT_ID_FILE=
				while [[ $CHAT_ID_FILE == "" ]]; do
					echo -e "\nPor favor, introduzca su CHAT_ID (no puede dejarse en blanco)."
					echo "Si no tiene uno, o no lo recuerda, póngase en contacto con @CabashiBot"
					echo "mediante Telegram, y envíele el comando '/chatid' (sin las comillas)."
					read CHAT_ID_FILE
				done

				echo -e "\nComprobando si cuenta con $AMBILIGHT en el sistema..."
				AMBI_PATH_FILE=$(find / -type f -name $AMBILIGHT 2>&1 | grep -v 'find:')

				mkdir $BOTPATH/config

				echo -n $TOKEN_BOT_FILE > $BOTPATH/config/token_bot
				echo -n $CHAT_ID_FILE > $BOTPATH/config/chat_id

				if [ $(echo $AMBI_PATH_FILE | wc -l) == 1 -a $(echo $AMBI_PATH_FILE) != "" ] ; then
					echo -n $AMBI_PATH_FILE > $BOTPATH/config/ambi_path
				else
					echo -n "NOPE" > $BOTPATH/config/ambi_path
				fi

				sudo chmod 444 $BOTPATH/config/*

				echo -e "\nComprobando si cuenta con $TORRENTSERVICEPKG en el sistema..."
				if (eval sudo $PM_CHECK $TORRENTSERVICEPKG >/dev/null 2>&1) ; then
					echo "Se ha detectado $TORRENTSERVICEPKG instalado en el sistema."

					if [[ $TORRENTSERVICEPKG == "transmission-daemon" ]]; then
						if (eval sudo $PM_CHECK transmission-cli >/dev/null 2>&1) ; then
							sudo $PM_INSTALL transmission-cli >/dev/null
						fi
					fi

					echo "A continuación es necesario introducir el usuario y contraseña"
					echo "del servicio para $TORRENTSERVICEPKG web. Introduzca su usuario:"
					read TORRENTUSER

					echo -e "\nIntroduzca la contraseña:"
					read TORRENTPASS

					echo "Se añadirá este servicio a la lista de alertas de RaspiBot."

					sudo sed -i 's^"script-torrent-done-enabled": false,^"script-torrent-done-enabled": true,^g' $TORRENTSERVICESETTINGS
  				sudo sed -i 's^"script-torrent-done-filename": "",^"script-torrent-done-filename": "'"$TORRENTALERTSCRIPT"'",^g' $TORRENTSERVICESETTINGS

  				echo -e '#!/bin/sh' | sudo tee $TORRENTALERTSCRIPT >/dev/null
  				echo -e 'torrentsalertfile="'"$TORRENTSFILE"'"' | sudo tee --append $TORRENTALERTSCRIPT >/dev/null
  				echo -e 'echo $TR_TORRENT_NAME > $torrentsalertfile' | sudo tee --append $TORRENTALERTSCRIPT >/dev/null
  				echo -e "exit 0" | sudo tee --append $TORRENTALERTSCRIPT >/dev/null

  				sudo systemctl reload $TORRENTCTLPKG

  				sudo chmod a+x $TORRENTALERTSCRIPT
  				echo -n $TORRENTUSER > $BOTPATH/config/torrentuser
					echo -n $TORRENTPASS > $BOTPATH/config/torrentpass
				fi

				sudo ln -s $BOTPATH/bin/raspibot /bin/raspibot

				echo "[Unit]" > $BOTPATH/$RASPIBOT_SERVICE
				echo "Description=RaspiBot for Telegram" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "[Service]" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "User=$SYS_USER" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "Type=oneshot" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "ExecStart=/bin/raspibot exec" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "TimeoutSec=0" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "RemainAfterExit=yes" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "[Install]" >> $BOTPATH/$RASPIBOT_SERVICE
				echo "WantedBy=multi-user.target" >> $BOTPATH/$RASPIBOT_SERVICE

				sudo mv $BOTPATH/$RASPIBOT_SERVICE $SYSTEMD_DIR

				sudo systemctl enable $RASPIBOT_SERVICE

				sudo systemctl start $RASPIBOT_SERVICE

				echo -e "\nSe ha creado, activado e iniciado el servicio 'raspibot'."
				echo "Puede consultar su estado con 'raspibot status'. Para ver más opciones,"
				echo "utilice 'raspibot help'."
				echo "Proceso de instalación completado. RaspiBot instalado."
				KEEPON=false
			;;
			### END CASE 1
			2)
				echo "******* ACTUALIZACIÓN SELECCIONADA *******"
				echo "Comprobando actualizaciones..."
				LOCALVERSION=$(cat $BOTPATH/version)
				REMOTEVERSION=$(curl -s https://raw.githubusercontent.com/alhenx/raspibot/master/version)
				if [ "$LOCALVERSION" != "$REMOTEVERSION" ]; then
					echo "Existe una nueva versión de RaspiBot. Actualizando..."
					update_bot # Utiliza la función update_bot.
				else
					echo "No hay actualizaciones disponibles para RaspiBot."
				fi
				KEEPON=false
			;;
			### END CASE 2
			3)
				echo "******* DESINSTALACIÓN SELECCIONADA *******"
				echo "Comenzando proceso de desinstalación..."
				cd # Va a /home/$SYS_USER
				echo "Identificando sistema operativo y gestor de paquetes..."
				declare -A osInfo;
				osInfo[/etc/arch-release]=pacman
				osInfo[/etc/debian_version]=apt-get

				for f in ${!osInfo[@]}
				do
				    if [[ -f $f ]];then
				    		SYSTEM_PM=${osInfo[$f]}
				        echo "El gestor de paquetes de su sistema es $SYSTEM_PM."
				    fi
				done

				case $SYSTEM_PM in
					pacman)
						SYSTEMD_DIR="/usr/lib/systemd/system/"
					;;
					apt-get)
						SYSTEMD_DIR="/lib/systemd/system/"
					;;
				esac

				sudo rm -rf $INSTALLDIR >/dev/null 2>&1
				sudo rm -rf $TORRENTENDPATH > /dev/null 2>&1
				sudo systemctl stop $RASPIBOT_SERVICE >/dev/null 2>&1
				sudo systemctl disable $RASPIBOT_SERVICE >/dev/null 2>&1
				sudo rm -f $SYSTEMD_DIR$RASPIBOT_SERVICE >/dev/null 2>&1
				sudo rm -f /bin/raspibot >/dev/null 2>&1
				sudo rm -f $RESTARTSCRIPT >/dev/null 2>&1
				sudo sed -i '\^'"$RESTARTSCRIPT"'^d' /etc/sudoers
				echo "Desinstalación completada."
				KEEPON=false
			;;
			### END CASE 3
			4)
				KEEPON=false
				echo "Saliendo..."
			;;
			*)
				echo "La opción seleccionada no es válida."
			;;
		esac
done

#end
